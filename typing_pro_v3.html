<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è‹±è¯­æ‰“å­—é€š - æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ</title>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --error: #ea4335; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; width: 95%; max-width: 900px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { background: #e8f0fe; color: var(--primary); padding: 8px 15px; border-radius: 50px; font-weight: bold; }

        /* æ ¸å¿ƒå±•ç¤ºåŒº */
        .word-display { text-align: center; margin: 40px 0; min-height: 150px; }
        #target-word { font-size: 60px; font-weight: 800; margin: 0; color: #202124; }
        #phonetic { color: #70757a; font-size: 20px; margin: 5px; }
        #meaning { color: var(--success); font-size: 24px; font-weight: 500; }
        #star-rating { color: #fbbc05; font-size: 24px; margin-top: 10px; }

        /* è¾“å…¥åŒº */
        #input-field { width: 100%; padding: 15px; font-size: 28px; border: 3px solid #eee; border-radius: 12px; text-align: center; transition: 0.3s; box-sizing: border-box; }
        #input-field:focus { border-color: var(--primary); outline: none; }
        
        /* åŠŸèƒ½åŒºé¢æ¿ */
        .panel { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h3 { font-size: 16px; color: #5f6368; margin-bottom: 10px; }
        textarea { width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; resize: none; box-sizing: border-box; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; transition: 0.2s; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-export { background: #607d8b; color: white; }
        
        .mistake-list { height: 100px; overflow-y: auto; background: #fff5f5; padding: 10px; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span id="level-info" class="badge">ç¬¬ 1 å…³ (0/12)</span>
        <div>
            <button class="btn btn-primary" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
            <button class="btn btn-export" onclick="exportMistakes()">å¯¼å‡ºç”Ÿè¯æœ¬ (.txt)</button>
        </div>
    </div>

    <div class="word-display">
        <div id="star-rating">â­â­â­</div>
        <h1 id="target-word">Ready?</h1>
        <div id="phonetic">/å•å‡»å¼€å§‹/</div>
        <div id="meaning">å‡†å¤‡å¥½æŒ‘æˆ˜äº†å—ï¼Ÿ</div>
    </div>

    <input type="text" id="input-field" placeholder="åœ¨æ­¤è¾“å…¥å•è¯..." disabled autocomplete="off">

    <div class="panel">
        <div>
            <h3>ğŸ“¥ ä¸€é”®å¯¼å…¥è¯¾æ–‡/å•è¯</h3>
            <textarea id="import-area" placeholder="åœ¨æ­¤ç²˜è´´è‹±æ–‡è¯¾æ–‡æˆ–å•è¯åˆ—è¡¨..."></textarea>
            <div style="margin-top:5px">
                <button class="btn btn-primary" style="font-size:12px" onclick="importCustom()">å¯¼å…¥è‡ªå®šä¹‰</button>
                <button class="btn btn-success" style="font-size:12px" onclick="loadPreset('primary')">å°å­¦è¯åº“</button>
                <button class="btn btn-success" style="font-size:12px" onclick="loadPreset('high')">é«˜ä¸­è¯åº“</button>
            </div>
        </div>
        <div>
            <h3>ğŸ“š ç”Ÿè¯æœ¬ (é—å¿˜æ›²çº¿ç›‘æ§ä¸­)</h3>
            <div id="mistake-list" class="mistake-list">æš‚æ— ç”Ÿè¯</div>
        </div>
    </div>
</div>

<script>
    // --- 1. åŸºç¡€é…ç½®ä¸è¯åº“ ---
    let wordList = [];
    let currentIdx = 0;
    let passCount = 0; // å½“å‰å…³å¡å·²é€šè¿‡æ•°é‡
    const WORDS_PER_LEVEL = 12;

    // è¿™é‡Œå°±æ˜¯ä½ çš„â€œä»“åº“â€ï¼Œä½ å¯ä»¥éšæ—¶å¾€é‡ŒåŠ è¯ï¼Œæ ¼å¼å¿…é¡»æ˜¯ {en: "å•è¯", cn: "æ„æ€"}
    const presets = {
        // å°å­¦è¯åº“ (ç²¾é€‰ 30 ä¸ªå¸¸ç”¨è¯)
        primary: [
            {en: "apple", cn: "è‹¹æœ"}, {en: "banana", cn: "é¦™è•‰"}, {en: "orange", cn: "æ©™å­"},
            {en: "water", cn: "æ°´"}, {en: "bread", cn: "é¢åŒ…"}, {en: "milk", cn: "ç‰›å¥¶"},
            {en: "school", cn: "å­¦æ ¡"}, {en: "teacher", cn: "è€å¸ˆ"}, {en: "student", cn: "å­¦ç”Ÿ"},
            {en: "pencil", cn: "é“…ç¬”"}, {en: "family", cn: "å®¶åº­"}, {en: "father", cn: "çˆ¶äº²"},
            {en: "mother", cn: "æ¯äº²"}, {en: "brother", cn: "å…„å¼Ÿ"}, {en: "sister", cn: "å§å¦¹"},
            {en: "happy", cn: "å¿«ä¹"}, {en: "small", cn: "å°çš„"}, {en: "large", cn: "å¤§çš„"},
            {en: "sunny", cn: "æ™´æœ—"}, {en: "cloudy", cn: "å¤šäº‘"}, {en: "rainy", cn: "ä¸‹é›¨"},
            {en: "animal", cn: "åŠ¨ç‰©"}, {en: "tiger", cn: "è€è™"}, {en: "monkey", cn: "çŒ´å­"},
            {en: "color", cn: "é¢œè‰²"}, {en: "green", cn: "ç»¿è‰²"}, {en: "yellow", cn: "é»„è‰²"},
            {en: "number", cn: "æ•°å­—"}, {en: "seven", cn: "ä¸ƒ"}, {en: "eight", cn: "å…«"}
        ],
        // é«˜ä¸­/è¿›é˜¶è¯åº“ (æ›´é•¿çš„å•è¯)
        high: [
            {en: "abandon", cn: "æ”¾å¼ƒ"}, {en: "brilliant", cn: "æ°å‡ºçš„"}, {en: "capacity", cn: "å®¹é‡"},
            {en: "destination", cn: "ç›®çš„åœ°"}, {en: "education", cn: "æ•™è‚²"}, {en: "frequency", cn: "é¢‘ç‡"},
            {en: "government", cn: "æ”¿åºœ"}, {en: "harmony", cn: "å’Œè°"}, {en: "influence", cn: "å½±å“"},
            {en: "judgment", cn: "åˆ¤æ–­"}, {en: "knowledge", cn: "çŸ¥è¯†"}, {en: "landscape", cn: "é£æ™¯"},
            {en: "maintain", cn: "ç»´æŒ"}, {en: "negative", cn: "æ¶ˆæçš„"}, {en: "obvious", cn: "æ˜æ˜¾çš„"},
            {en: "performance", cn: "è¡¨æ¼”"}, {en: "quality", cn: "è´¨é‡"}, {en: "reasonable", cn: "åˆç†çš„"},
            {en: "strategy", cn: "ç­–ç•¥"}, {en: "technique", cn: "æŠ€å·§"}, {en: "ultimate", cn: "æœ€ç»ˆçš„"},
            {en: "various", cn: "å„ç§å„æ ·çš„"}, {en: "wonderful", cn: "ç²¾å½©çš„"}, {en: "yesterday", cn: "æ˜¨å¤©"}
        ]
    };

    // --- 2. æ ¸å¿ƒé€»è¾‘å˜é‡ ---
    // mistakeData æ ¼å¼: { "word": {en, cn, errorCount, correctStreak} }
    let mistakeData = JSON.parse(localStorage.getItem('typing_mistake_data')) || {};

    // --- 3. éŸ³æ•ˆç³»ç»Ÿ (åˆ©ç”¨æµè§ˆå™¨åˆæˆå£°éŸ³) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'correct') { // ç®€å•çš„é¼“æŒ/æˆåŠŸéŸ³æ•ˆ
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } else { // â€œå“”â€çš„é”™è¯¯éŸ³
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
    }

    // å•è¯å‘éŸ³
    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'en-US';
        window.speechSynthesis.speak(msg);
    }

    // --- 4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

    function startGame() {
        if(wordList.length === 0) {
            alert("è¯·å…ˆé€‰æ‹©è¯åº“æˆ–å¯¼å…¥è¯¾æ–‡ï¼");
            return;
        }
        currentIdx = 0;
        passCount = 0;
        document.getElementById('input-field').disabled = false;
        document.getElementById('input-field').focus();
        updateDisplay();
    }

    function updateDisplay() {
        const item = wordList[currentIdx];
        const mInfo = mistakeData[item.en] || { errorCount: 0 };
        
        // æ›´æ–° UI
        document.getElementById('target-word').innerText = item.en;
        document.getElementById('meaning').innerText = item.cn;
        document.getElementById('level-info').innerText = `ç»ƒä¹ ä¸­ (${passCount}/${WORDS_PER_LEVEL})`;
        
        // éš¾åº¦æ˜Ÿçº§ï¼šé”™å¾—è¶Šå¤šæ˜Ÿè¶Šå¤š
        let stars = "â­".repeat(Math.min(mInfo.errorCount, 5));
        document.getElementById('star-rating').innerText = stars || "æ–°è¯";

        speak(item.en);
        renderMistakeList();
    }

    // æ£€æŸ¥è¾“å…¥
    document.getElementById('input-field').addEventListener('input', function(e) {
        const target = wordList[currentIdx].en;
        if (!target.startsWith(this.value)) {
            playSound('error');
            this.style.color = 'var(--error)';
            recordMistake(wordList[currentIdx]);
        } else {
            this.style.color = 'black';
        }
    });

    document.getElementById('input-field').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            if (this.value.trim() === wordList[currentIdx].en) {
                playSound('correct');
                recordSuccess(wordList[currentIdx]);
                this.value = "";
                nextWord();
            }
        }
    });

    function nextWord() {
        passCount++; // æ¯æ‰“å¯¹ä¸€ä¸ªï¼Œè®¡æ•°åŠ  1
        
        // æ£€æŸ¥æ˜¯å¦æ‰“å¤Ÿäº† 12 ä¸ª
        if (passCount >= WORDS_PER_LEVEL) {
            alert("ğŸ‰ å¤ªæ£’äº†ï¼è¿™ä¸€å…³çš„ 12 ä¸ªå•è¯ä½ éƒ½æå®šäº†ï¼å‡†å¤‡è¿›å…¥ä¸‹ä¸€ç»„å•è¯ã€‚");
            passCount = 0; // é‡ç½®è®¡æ•°ï¼Œä¸ºä¸‹ä¸€å…³å‡†å¤‡
        }

        // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•è¯
        currentIdx++; 

        // å¦‚æœè¯åº“é‡Œçš„è¯å…¨æ‰“å®Œäº†ï¼Œå°±å›åˆ°ç¬¬ 1 ä¸ªé‡æ–°å¼€å§‹
        if (currentIdx >= wordList.length) {
            currentIdx = 0;
            alert("è¯åº“å·²ç»å…¨éƒ¨ç»ƒä¹ ä¸€éå•¦ï¼ŒçœŸäº†ä¸èµ·ï¼");
        }
        
        updateDisplay(); // åˆ·æ–°å±å¹•æ˜¾ç¤ºæ–°å•è¯
    }

    // --- 5. ç”Ÿè¯æœ¬ä¸é—å¿˜æ›²çº¿é€»è¾‘ ---

    function recordMistake(item) {
        if (!mistakeData[item.en]) {
            mistakeData[item.en] = { ...item, errorCount: 1, correctStreak: 0 };
        } else {
            mistakeData[item.en].errorCount++;
            mistakeData[item.en].correctStreak = 0; // åªè¦é”™ä¸€æ¬¡ï¼Œè¿ç»­æ­£ç¡®æ•°æ¸…é›¶
        }
        saveData();
    }

    function recordSuccess(item) {
        if (mistakeData[item.en]) {
            mistakeData[item.en].correctStreak++;
            // é—å¿˜æ›²çº¿é€»è¾‘ï¼šå¦‚æœè¿ç»­æ‰“å¯¹ 5 æ¬¡ï¼Œè®¤ä¸ºå·²æŒæ¡ï¼Œä»ç”Ÿè¯æœ¬ç§»é™¤
            if (mistakeData[item.en].correctStreak >= 5) {
                delete mistakeData[item.en];
            }
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem('typing_mistake_data', JSON.stringify(mistakeData));
    }

    function renderMistakeList() {
        const listEl = document.getElementById('mistake-list');
        const keys = Object.keys(mistakeData);
        
        // å¦‚æœç”Ÿè¯æœ¬æ˜¯ç©ºçš„
        if (keys.length === 0) {
            listEl.innerHTML = `
                <div style="text-align:center; padding:20px; color:#999;">
                    <p>ğŸƒ ç”Ÿè¯æœ¬ç©ºç©ºå¦‚ä¹Ÿï¼Œä½ å¤ªæ£’äº†ï¼</p>
                </div>`;
            return;
        }

        // å¼€å§‹æ„å»ºä¸€ä¸ªæ¼‚äº®çš„åˆ—è¡¨ç•Œé¢
        let html = `
            <div style="background:#fff; border-radius:10px; overflow:hidden;">
                <div style="display:grid; grid-template-columns: 2fr 2fr 1.5fr 1.5fr; background:#f8f9fa; padding:10px; font-weight:bold; border-bottom:2px solid #eee; font-size:14px;">
                    <div>è‹±æ–‡å•è¯</div>
                    <div>ä¸­æ–‡ç¿»è¯‘</div>
                    <div>éš¾åº¦æŒ‡æ•°</div>
                    <div>æŒæ¡è¿›åº¦</div>
                </div>
        `;

        // å¾ªç¯æŠŠæ¯ä¸ªå•è¯æ”¾è¿›å»
        keys.forEach(key => {
            const wordInfo = mistakeData[key];
            // è®¡ç®—æŒæ¡ç™¾åˆ†æ¯”ï¼šè¿å¯¹5æ¬¡ç®—100%
            const progress = Math.min((wordInfo.correctStreak / 5) * 100, 100);
            
            html += `
                <div style="display:grid; grid-template-columns: 2fr 2fr 1.5fr 1.5fr; padding:12px 10px; border-bottom:1px solid #f1f1f1; align-items:center; font-size:14px;">
                    <div style="font-weight:bold; color:#1a73e8;">${wordInfo.en}</div>
                    <div style="color:#5f6368;">${wordInfo.cn}</div>
                    <div style="color:#fbbc05;">${"â˜…".repeat(Math.min(wordInfo.errorCount, 5))}</div>
                    <div>
                        <div style="width:60px; background:#eee; height:8px; border-radius:4px; overflow:hidden;">
                            <div style="width:${progress}%; background:#34a853; height:100%;"></div>
                        </div>
                        <span style="font-size:10px; color:#999;">${wordInfo.correctStreak}/5</span>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        listEl.innerHTML = html;
    }

    // --- 6. å¯¼å…¥ä¸å¯¼å‡º ---

    function importCustom() {
        const text = document.getElementById('import-area').value;
        // ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼ï¼šæå–æ‰€æœ‰è‹±æ–‡å•è¯
        const words = text.match(/[a-zA-Z]+/g);
        if (words) {
            wordList = words.map(w => ({ en: w.toLowerCase(), cn: "è‡ªå®šä¹‰å†…å®¹" }));
            alert(`æˆåŠŸå¯¼å…¥ ${wordList.length} ä¸ªå•è¯ï¼`);
            startGame();
        }
    }

    function loadPreset(type) {
        wordList = presets[type];
        alert("è¯åº“åŠ è½½æˆåŠŸï¼");
        startGame();
    }

    function exportMistakes() {
        const keys = Object.keys(mistakeData);
        if(keys.length === 0) return alert("ç”Ÿè¯æœ¬æ˜¯ç©ºçš„ï¼");
        
        let content = "--- æˆ‘çš„ç”Ÿè¯æœ¬ ---\n\n";
        content += keys.map(k => {
            const m = mistakeData[k];
            return `${m.en} [æ˜Ÿçº§:${m.errorCount}] - ${m.cn}`;
        }).join('\n');

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ç”Ÿè¯æœ¬.txt';
        a.click();
    }

    // åˆå§‹åŒ–æ˜¾ç¤º
    renderMistakeList();
</script>

</body>
</html>